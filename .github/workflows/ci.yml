name: Cookiecutter Test

on:
  push:
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:

  template-tests:
    name: Template Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repo
        uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          python-version: "3.13"

      - name: Install test dependencies
        run: uv sync --group tests

      - name: Run template tests
        run: uv run pytest tests/ -v

  generated-project-tests:
    name: Generated Project Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repo
        uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          python-version: "3.13"

      - name: Create new project
        run: |
          uvx cookiecutter . --no-input
          cd complexity
          git init
          git config user.email "ci@test.com"
          git config user.name "CI"

      - name: Sync project with tests deps
        working-directory: complexity
        run: |
          uv lock
          uv sync --group tests --group lint --locked

      - name: Cache pre-commit
        id: precommit-cache
        uses: actions/cache@v5
        with:
          path: /home/runner/.cache/pre-commit/
          key: pre-commit|${{ runner.os }}|${{ runner.arch }}|${{ hashFiles('complexity/.pre-commit-config.yaml', 'complexity/pyproject.toml', 'complexity/uv.lock') }}
          restore-keys: |
            pre-commit|${{ runner.os }}|${{ runner.arch }}|

      - name: Run lint
        working-directory: complexity
        run: make lint

      - name: Run test
        working-directory: complexity
        run: make test-all

  auto_merge_deps:
    name: Auto Merge dependencies labeled PRs
    needs: [template-tests, generated-project-tests]
    # Run only on pull_request labeled dependencies (e.g. by dependabot) or
    # with the pre-commit ci commit message.
    if: >
      startsWith(github.event.pull_request.title, 'build(pre-commit): update hooks') ||
      contains(github.event.pull_request.labels.*.name, 'dependencies')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      - name: Merge PR
        uses: pascalgn/automerge-action@v0.16.4
        env:
          GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
          MERGE_LABELS: ""
          MERGE_METHOD: squash
          DELETE_BRANCH_AFTER_MERGE: true
          LOG: "TRACE" # or DEBUG
